<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Maxmillian – Products</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="logo">
      <span></span>
      Maxmillian
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="products.html" class="active">Products</a>
      <a href="payment.html">Payment</a>
    </nav>
  </header>

  <main class="main-container">
    <div class="section-header">
      <div class="section-tag">Storefront</div>
      <div class="section-title">Available Products</div>
      <p style="margin-top:4px; color:#9ca3af; font-size:0.86rem;">
        Filter by category, search, sort, then tap <strong>Order</strong> to continue to the WhatsApp payment step.
      </p>

      <div class="products-toolbar">
        <div style="flex:1; min-width:180px;">
          <label for="searchInput">Search</label>
          <input type="text" id="searchInput" placeholder="Search by name or description" />
        </div>
        <div>
          <label for="categoryFilter">Category</label>
          <select id="categoryFilter">
            <option value="all">All categories</option>
          </select>
        </div>
        <div>
          <label for="sortSelect">Sort by</label>
          <select id="sortSelect">
            <option value="default">Default</option>
            <option value="price-asc">Price: Low → High</option>
            <option value="price-desc">Price: High → Low</option>
          </select>
        </div>
      </div>
    </div>

    <div id="productsGrid" class="products-grid">
      <!-- Products loaded by JS -->
    </div>
  </main>

  <script>
    var allProducts = [];

    async function loadProducts() {
      try {
        var res = await fetch("/api/products");
        allProducts = await res.json();
        populateCategoryFilter();
        renderProducts();
      } catch (err) {
        console.error(err);
      }
    }

    function populateCategoryFilter() {
      var select = document.getElementById("categoryFilter");
      // Clear and re-add "All"
      select.innerHTML = '<option value="all">All categories</option>';
      var cats = Array.from(new Set(allProducts.map(p => p.category).filter(Boolean)));
      cats.forEach(function (c) {
        var opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });
    }

    function renderProducts() {
      var grid = document.getElementById("productsGrid");
      grid.innerHTML = "";

      if (!allProducts.length) {
        var empty = document.createElement("div");
        empty.style.color = "#9ca3af";
        empty.style.fontSize = "0.9rem";
        empty.textContent = "No products available yet.";
        grid.appendChild(empty);
        return;
      }

      var search = document.getElementById("searchInput").value.toLowerCase();
      var sort = document.getElementById("sortSelect").value;
      var catFilter = document.getElementById("categoryFilter").value;

      var filtered = allProducts.filter(function (p) {
        var title = (p.title || "").toLowerCase();
        var desc = (p.description || "").toLowerCase();
        var inSearch = !search || title.includes(search) || desc.includes(search);
        var inCat = (catFilter === "all") || (p.category === catFilter);
        return inSearch && inCat;
      });

      if (sort === "price-asc") {
        filtered.sort(function (a, b) {
          return Number(a.price || 0) - Number(b.price || 0);
        });
      } else if (sort === "price-desc") {
        filtered.sort(function (a, b) {
          return Number(b.price || 0) - Number(a.price || 0);
        });
      }

      filtered.forEach(function (p) {
        var card = document.createElement("div");
        card.className = "product-card";

        var topDiv = document.createElement("div");

        var title = document.createElement("div");
        title.className = "product-title";
        title.textContent = p.title;

        var price = document.createElement("div");
        price.className = "product-price";
        price.textContent = "₦" + Number(p.price).toLocaleString();

        var desc = document.createElement("div");
        desc.className = "product-desc";
        desc.textContent = p.description || "";

        var tags = document.createElement("div");
        tags.className = "product-tags";

        if (p.category) {
          var cat = document.createElement("span");
          cat.className = "pill";
          cat.textContent = p.category;
          tags.appendChild(cat);
        }

        if (p.featured) {
          var feat = document.createElement("span");
          feat.className = "featured-badge";
          feat.textContent = "★ Featured";
          tags.appendChild(feat);
        }

        topDiv.appendChild(title);
        topDiv.appendChild(price);
        topDiv.appendChild(desc);
        topDiv.appendChild(tags);

        var btn = document.createElement("a");
        btn.className = "btn btn-primary";
        var itemParam = encodeURIComponent(p.title);
        var priceParam = encodeURIComponent(p.price);
        btn.href = "payment.html?item=" + itemParam + "&price=" + priceParam;
        btn.textContent = "Order";

        card.appendChild(topDiv);
        card.appendChild(btn);
        grid.appendChild(card);
      });
    }

    document.getElementById("searchInput").addEventListener("input", renderProducts);
    document.getElementById("sortSelect").addEventListener("change", renderProducts);
    document.getElementById("categoryFilter").addEventListener("change", renderProducts);

    loadProducts();
  </script>
</body>
</html>
